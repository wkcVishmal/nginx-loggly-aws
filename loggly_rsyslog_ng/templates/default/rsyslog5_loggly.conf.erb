# Generated by Chef for <%= node['fqdn'] %>
# Local modifications will be overwritten.

$InputFileName <%= @log_filename %>
$InputFileTag <%= @rsyslog_tag %>:
$InputFileStateFile <%= 'imfile-state:' + @uniq_name %>
$InputRunFileMonitor

# Setup disk assisted queues
$WorkDirectory /var/spool/rsyslog # where to place spool files
$ActionQueueFileName <%= 'actionqueue' + @uniq_name %>     # unique name prefix for spool files
$ActionQueueMaxDiskSpace 100M       # 1gb space limit (use as much as possible)
$ActionQueueSaveOnShutdown on     # save messages to disk on shutdown
$ActionQueueType LinkedList       # run asynchronously
$ActionResumeRetryCount -1        # infinite retries if host is down

$template <%= 'template' + @uniq_name %>,"<%%pri%>%protocol-version% %timestamp:::date-rfc3339% %HOSTNAME% %app-name% %procid% %msgid% [<%= @loggly_token %>@41058 <%= @loggly_tags %>] %msg%\n"

<% unless @rsyslog_bundled_tls_enable %>
<% if @rsyslog_tls_enable %>
$DefaultNetstreamDriverCAFile <%= @loggly_tls_path %>/<%= @loggly_tls_name %>
$ActionSendStreamDriver gtls
$ActionSendStreamDriverMode 1
$ActionSendStreamDriverAuthMode x509/name
$ActionSendStreamDriverPermittedPeer *.loggly.com
<% end %>

<%= @rsyslog_selector %> @@<%= @loggly_host %>:<%= @loggly_port %>;<%= 'template' + @uniq_name %>
<% else %>
<%= @rsyslog_selector %> action(type="omfwd" Protocol="tcp" Target="<%= @loggly_host %>" Port="<%= @loggly_port %>" StreamDriverMode="1" StreamDriver="gtls" StreamDriverAuthMode="x509/name" StreamDriverPermittedPeers="*.loggly.com" template="<%= 'template' + @uniq_name %>")
<% end %>
