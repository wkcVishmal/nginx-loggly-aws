# Generated by Chef for <%= node['fqdn'] %>
# Local modifications will be overwritten.

<% if !@rsyslog_bundled_tls_enable && @rsyslog_tls_enable %>
global(defaultNetstreamDriverCAFile="<%= @loggly_tls_path %>/<%= @loggly_tls_name %>")
<% end %>

template(name="<%= 'template' + @uniq_name %>"
         type="string"
         string="<%%pri%>%protocol-version% %timestamp:::date-rfc3339% %HOSTNAME% %app-name% %procid% %msgid% [<%= @loggly_token %>@41058 <%= @loggly_tags %>] %msg%\n"
)

<% if @rsyslog_ruleset %>
ruleset(name="<%= @rsyslog_ruleset %>"
        queue.filename="<%= 'mainqueue' + @uniq_name %>"
	queue.size="200000"
	queue.type="LinkedList"
	queue.maxdiskspace="100M"
	queue.saveonshutdown="on"){
<% end %>
<% if @rsyslog_tls_enable %>
<%= @rsyslog_selector %> action(name="<%= 'action' + @uniq_name %>"
                                type="omfwd"
				Protocol="tcp"
				Target="<%= @loggly_host %>"
				Port="<%= @loggly_port %>"
				StreamDriverMode="1"
				StreamDriver="gtls"
				StreamDriverAuthMode="x509/name"
				StreamDriverPermittedPeers="*.loggly.com"
				Template="<%= 'template' + @uniq_name %>"
				action.resumeRetryCount="-1"
			        queue.filename="<%= 'actionqueue' + @uniq_name %>"
                         	queue.size="200000"
                        	queue.type="LinkedList"
				queue.maxdiskspace="100M"
			        queue.saveonshutdown="on")
<% else %>
<%= @rsyslog_selector %> action(name="<%= 'action' + @uniq_name %>"
                                type="omfwd"
				Protocol="tcp"
				Target="<%= @host %>"
				Port="<%= @port %>"
				Template="<%= 'template' + @uniq_name %>"
				action.resumeRetryCount="-1"
			        queue.filename="<%= 'actionqueue' + @uniq_name %>"
                         	queue.size="200000"
                        	queue.type="LinkedList"
				queue.maxdiskspace="100M"
			        queue.saveonshutdown="on")
<% end %>
<% if @rsyslog_ruleset %>
}
<% end %>

input(type="imfile"
      File="<%= @log_filename %>"
<% if @rsyslog_tag %>
      Tag="<%= @rsyslog_tag +':' %>"
<% end %>
      StateFile="<%= 'imfile-state:' + @uniq_name %>"
<% if @rsyslog_ruleset %>
      Ruleset="<%= @rsyslog_ruleset %>"
<% end %>
)
